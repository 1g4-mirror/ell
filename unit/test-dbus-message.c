/*
 *
 *  Embedded Linux library
 *
 *  Copyright (C) 2011-2012  Intel Corporation. All rights reserved.
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License version 2 as
 *  published by the Free Software Foundation.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 *
 */

#ifdef HAVE_CONFIG_H
#include <config.h>
#endif

#include <assert.h>

#include <ell/ell.h>
#include <ell/dbus.h>

#include "ell/private.h"

static bool do_print = false;

struct message_data {
	const char *type;
	const char *sender;
	const char *path;
	const char *interface;
	const char *member;
	const char *destination;
	const char *signature;
	uint32_t serial;
	uint32_t reply_serial;
	bool no_reply;
	bool auto_start;
	uint32_t unix_fds;
	const unsigned char *binary;
	size_t binary_len;
};

static const unsigned char message_binary_basic_1[] = {
			0x6c, 0x01, 0x00, 0x01, 0x13, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x6f, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x01, 0x73, 0x00, 0x00,
			0x0e, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x20, 0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c,
			0x64, 0x73, 0x00,
};

static const struct message_data message_data_basic_1 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "s",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_basic_1,
	.binary_len	= 147,
};

static const unsigned char message_binary_basic_2[] = {
			0x6c, 0x01, 0x00, 0x01, 0x19, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x02, 0x73, 0x73, 0x00,
			0x05, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c, 0x64, 0x73,
			0x00,
};

static const struct message_data message_data_basic_2 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "ss",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_basic_2,
	.binary_len	= 153,
};

static const unsigned char message_binary_basic_3[] = {
			0x6c, 0x01, 0x00, 0x01, 0x18, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x02, 0x73, 0x62, 0x00,
			0x0e, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x20, 0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c,
			0x64, 0x73, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
};

static const struct message_data message_data_basic_3 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "sb",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_basic_3,
	.binary_len	= 152,
};

static const unsigned char message_binary_struct_1[] = {
			0x6c, 0x01, 0x00, 0x01, 0x19, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x72, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x04, 0x28, 0x73, 0x73,
			0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x05, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c, 0x64, 0x73,
			0x00,
};

static const struct message_data message_data_struct_1 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "(ss)",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_struct_1,
	.binary_len	= 161,
};

static const unsigned char message_binary_struct_2[] = {
			0x6c, 0x01, 0x00, 0x01, 0x31, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x75, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x07, 0x28, 0x73, 0x28,
			0x73, 0x73, 0x29, 0x29, 0x00, 0x00, 0x00, 0x00,
			0x0e, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x20, 0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c,
			0x64, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x05, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c, 0x64, 0x73,
			0x00,
};

static const struct message_data message_data_struct_2 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "(s(ss))",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_struct_2,
	.binary_len	= 185,
};

static const unsigned char message_binary_array_1[] = {
			0x6c, 0x01, 0x00, 0x01, 0x1d, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x02, 0x61, 0x73, 0x00,
			0x19, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
			0x4c, 0x69, 0x6e, 0x75, 0x73, 0x00, 0x00, 0x00,
			0x08, 0x00, 0x00, 0x00, 0x54, 0x6f, 0x72, 0x76,
			0x61, 0x6c, 0x64, 0x73, 0x00,
};

static const struct message_data message_data_array_1 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "as",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_array_1,
	.binary_len	= 157,
};

static const unsigned char message_binary_array_2[] = {
			0x6c, 0x01, 0x00, 0x01, 0x10, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x02, 0x61, 0x62, 0x00,
			0x0c, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
			0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const struct message_data message_data_array_2 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "ab",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_array_2,
	.binary_len	= 144,
};

static const unsigned char message_binary_array_3[] = {
			0x6c, 0x01, 0x00, 0x01, 0x40, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x71, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x03, 0x61, 0x61, 0x73,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x3c, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x0e, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x20, 0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c,
			0x64, 0x73, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00,
			0x05, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c, 0x64, 0x73,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const struct message_data message_data_array_3 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "aas",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_array_3,
	.binary_len	= 200,
};

static const unsigned char message_binary_array_4[] = {
			0x6c, 0x01, 0x00, 0x01, 0x41, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x73, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x05, 0x61, 0x28, 0x73,
			0x73, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x05, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c, 0x64, 0x73,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x00, 0x00, 0x00, 0x4d, 0x61, 0x72, 0x63,
			0x65, 0x6c, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x48, 0x6f, 0x6c, 0x74, 0x6d, 0x61, 0x6e, 0x6e,
			0x00,
};

static const struct message_data message_data_array_4 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "a(ss)",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_array_4,
	.binary_len	= 201,
};

static const unsigned char message_binary_array_5[] = {
			0x6c, 0x01, 0x00, 0x01, 0x3d, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x72, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x04, 0x61, 0x73, 0x61,
			0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x19, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
			0x4c, 0x69, 0x6e, 0x75, 0x73, 0x00, 0x00, 0x00,
			0x08, 0x00, 0x00, 0x00, 0x54, 0x6f, 0x72, 0x76,
			0x61, 0x6c, 0x64, 0x73, 0x00, 0x00, 0x00, 0x00,
			0x19, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x4d, 0x61, 0x72, 0x63, 0x65, 0x6c, 0x00, 0x00,
			0x08, 0x00, 0x00, 0x00, 0x48, 0x6f, 0x6c, 0x74,
			0x6d, 0x61, 0x6e, 0x6e, 0x00,
};

static const struct message_data message_data_array_5 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "asas",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_array_5,
	.binary_len	= 197,
};

static const unsigned char message_binary_array_6[] = {
			0x6c, 0x01, 0x00, 0x01, 0x24, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x02, 0x61, 0x76, 0x00,
			0x20, 0x00, 0x00, 0x00, 0x01, 0x73, 0x00, 0x00,
			0x0e, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x20, 0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c,
			0x64, 0x73, 0x00, 0x01, 0x62, 0x00, 0x00, 0x00,
			0x01, 0x00, 0x00, 0x00,
};

static const struct message_data message_data_array_6 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "av",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_array_6,
	.binary_len	= 164,
};

static const unsigned char message_binary_dict_1[] = {
			0x6c, 0x01, 0x00, 0x01, 0x08, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x73, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x05, 0x61, 0x7b, 0x73,
			0x76, 0x7d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const struct message_data message_data_dict_1 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "a{sv}",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_dict_1,
	.binary_len	= 144,
};

static const unsigned char message_binary_dict_2[] = {
			0x6c, 0x01, 0x00, 0x01, 0x40, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x73, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x05, 0x61, 0x7b, 0x73,
			0x76, 0x7d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x04, 0x00, 0x00, 0x00, 0x4e, 0x61, 0x6d, 0x65,
			0x00, 0x01, 0x73, 0x00, 0x0e, 0x00, 0x00, 0x00,
			0x4c, 0x69, 0x6e, 0x75, 0x73, 0x20, 0x54, 0x6f,
			0x72, 0x76, 0x61, 0x6c, 0x64, 0x73, 0x00, 0x00,
			0x09, 0x00, 0x00, 0x00, 0x44, 0x65, 0x76, 0x65,
			0x6c, 0x6f, 0x70, 0x65, 0x72, 0x00, 0x01, 0x62,
			0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
};

static const struct message_data message_data_dict_2 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "a{sv}",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_dict_2,
	.binary_len	= 200,
};

static const unsigned char message_binary_dict_3[] = {
			0x6c, 0x01, 0x00, 0x01, 0x41, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x73, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x05, 0x61, 0x7b, 0x73,
			0x73, 0x7d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x05, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c, 0x64, 0x73,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x00, 0x00, 0x00, 0x4d, 0x61, 0x72, 0x63,
			0x65, 0x6c, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x48, 0x6f, 0x6c, 0x74, 0x6d, 0x61, 0x6e, 0x6e,
			0x00,
};

static const struct message_data message_data_dict_3 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "a{ss}",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_dict_3,
	.binary_len	= 201,
};

static const unsigned char message_binary_variant_1[] = {
			0x6c, 0x01, 0x00, 0x01, 0x17, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x6f, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x01, 0x76, 0x00, 0x00,
			0x01, 0x73, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00,
			0x4c, 0x69, 0x6e, 0x75, 0x73, 0x20, 0x54, 0x6f,
			0x72, 0x76, 0x61, 0x6c, 0x64, 0x73, 0x00,
};

static const struct message_data message_data_variant_1 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "v",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_variant_1,
	.binary_len	= 151,
};

static const unsigned char message_binary_variant_2[] = {
			0x6c, 0x01, 0x00, 0x01, 0x21, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x6f, 0x00, 0x00, 0x00,
			0x01, 0x01, 0x6f, 0x00, 0x13, 0x00, 0x00, 0x00,
			0x2f, 0x63, 0x6f, 0x6d, 0x2f, 0x65, 0x78, 0x61,
			0x6d, 0x70, 0x6c, 0x65, 0x2f, 0x6f, 0x62, 0x6a,
			0x65, 0x63, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x06, 0x01, 0x73, 0x00, 0x0b, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x02, 0x01, 0x73, 0x00, 0x15, 0x00, 0x00, 0x00,
			0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d,
			0x70, 0x6c, 0x65, 0x2e, 0x69, 0x6e, 0x74, 0x65,
			0x72, 0x66, 0x61, 0x63, 0x65, 0x00, 0x00, 0x00,
			0x03, 0x01, 0x73, 0x00, 0x06, 0x00, 0x00, 0x00,
			0x6d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x00,
			0x08, 0x01, 0x67, 0x00, 0x01, 0x76, 0x00, 0x00,
			0x02, 0x61, 0x73, 0x00, 0x19, 0x00, 0x00, 0x00,
			0x05, 0x00, 0x00, 0x00, 0x4c, 0x69, 0x6e, 0x75,
			0x73, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
			0x54, 0x6f, 0x72, 0x76, 0x61, 0x6c, 0x64, 0x73,
			0x00,
};

static const struct message_data message_data_variant_2 = {
	.type		= "method_call",
	.path		= "/com/example/object",
	.interface	= "com.example.interface",
	.member		= "method",
	.destination	= "com.example",
	.signature	= "v",
	.serial		= 0,
	.reply_serial	= 0,
	.no_reply	= 0,
	.auto_start	= 1,
	.unix_fds	= 0,
	.binary		= message_binary_variant_2,
	.binary_len	= 161,
};

static void do_debug(const char *str, void *user_data)
{
	const char *prefix = user_data;

	l_info("%s%s", prefix, str);
}

static struct l_dbus_message *check_message(const struct message_data *msg_data)
{
	struct l_dbus_message *msg;

	msg = dbus_message_build(msg_data->binary, msg_data->binary_len);
	assert(msg);

	if (do_print)
		l_util_hexdump(false, msg_data->binary, msg_data->binary_len,
							do_debug, "[MSG] ");

	if (msg_data->sender) {
		const char *sender;

		sender = l_dbus_message_get_sender(msg);
		assert(sender);
		assert(!strcmp(msg_data->sender, sender));

		if (do_print)
			l_info("sender=%s", sender);
        }

	if (msg_data->destination) {
		const char *destination;

		destination = l_dbus_message_get_destination(msg);
		assert(destination);
		assert(!strcmp(msg_data->destination, destination));

		if (do_print)
			l_info("destination=%s", destination);
	}

	return msg;
}

static void check_basic_1(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	const char *str;
	bool result;

	result = l_dbus_message_get_arguments(msg, "s", &str);
	assert(result);
	assert(!strcmp(str, "Linus Torvalds"));

	l_dbus_message_unref(msg);
}

static void check_basic_2(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	const char *str1, *str2;
	bool result;

	result = l_dbus_message_get_arguments(msg, "ss", &str1, &str2);
	assert(result);
	assert(!strcmp(str1, "Linus"));
	assert(!strcmp(str2, "Torvalds"));

	l_dbus_message_unref(msg);
}

static void check_basic_3(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	const char *str;
	uint32_t val;
	bool result;

	result = l_dbus_message_get_arguments(msg, "sb", &str, &val);
	assert(result);
	assert(!strcmp(str, "Linus Torvalds"));
	assert(val == 1);

	l_dbus_message_unref(msg);
}

static void check_struct_1(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	const char *str1, *str2;
	bool result;

	result = l_dbus_message_get_arguments(msg, "(ss)", &str1, &str2);
	assert(result);
	assert(!strcmp(str1, "Linus"));
	assert(!strcmp(str2, "Torvalds"));

	l_dbus_message_unref(msg);
}

static void check_struct_2(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	const char *str, *str1, *str2;
	bool result;

	result = l_dbus_message_get_arguments(msg, "(s(ss))",
							&str, &str1, &str2);
	assert(result);
	assert(!strcmp(str, "Linus Torvalds"));
	assert(!strcmp(str1, "Linus"));
	assert(!strcmp(str2, "Torvalds"));

	l_dbus_message_unref(msg);
}

static void check_array_1(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter iter;
	const char *str;
	bool result;

	result = l_dbus_message_get_arguments(msg, "as", &iter);
	assert(result);

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(result);
	assert(!strcmp(str, "Linus"));

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(result);
	assert(!strcmp(str, "Torvalds"));

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_array_2(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter iter;
	uint32_t val;
	bool result;

	result = l_dbus_message_get_arguments(msg, "ab", &iter);
	assert(result);

	result = l_dbus_message_iter_next_entry(&iter, &val);
	assert(result);
	assert(val == 1);

	result = l_dbus_message_iter_next_entry(&iter, &val);
	assert(result);
	assert(val == 1);

	result = l_dbus_message_iter_next_entry(&iter, &val);
	assert(result);
	assert(val == 0);

	result = l_dbus_message_iter_next_entry(&iter, &val);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_array_3(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter array, iter;
	const char *str;
	bool result;

	result = l_dbus_message_get_arguments(msg, "aas", &array);
	assert(result);

	/* Top-level array's first element */
	result = l_dbus_message_iter_next_entry(&array, &iter);
	assert(result);

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(result);
	assert(!strcmp(str, "Linus Torvalds"));

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(!result);

	/* Top-level array's second element */
	result = l_dbus_message_iter_next_entry(&array, &iter);
	assert(result);

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(result);
	assert(!strcmp(str, "Linus"));

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(result);
	assert(!strcmp(str, "Torvalds"));

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(!result);

	/* Top-level array's third element */
	result = l_dbus_message_iter_next_entry(&array, &iter);
	assert(result);

	result = l_dbus_message_iter_next_entry(&iter, &str);
	assert(!result);

	/* Top-level array's end element */
	result = l_dbus_message_iter_next_entry(&array, &iter);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_array_4(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter array;
	const char *str1, *str2;
	bool result;

	result = l_dbus_message_get_arguments(msg, "a(ss)", &array);
	assert(result);

	result = l_dbus_message_iter_next_entry(&array, &str1, &str2);
	assert(result);
	assert(!strcmp(str1, "Linus"));
	assert(!strcmp(str2, "Torvalds"));

	result = l_dbus_message_iter_next_entry(&array, &str1, &str2);
	assert(result);
	assert(!strcmp(str1, "Marcel"));
	assert(!strcmp(str2, "Holtmann"));

	result = l_dbus_message_iter_next_entry(&array, &str1, &str2);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_array_5(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter array1, array2;
	const char *str;
	bool result;

	result = l_dbus_message_get_arguments(msg, "asas", &array1, &array2);
	assert(result);

	result = l_dbus_message_iter_next_entry(&array1, &str);
	assert(result);
	assert(!strcmp(str, "Linus"));

	result = l_dbus_message_iter_next_entry(&array1, &str);
	assert(result);
	assert(!strcmp(str, "Torvalds"));

	result = l_dbus_message_iter_next_entry(&array1, &str);
	assert(!result);

	result = l_dbus_message_iter_next_entry(&array2, &str);
	assert(result);
	assert(!strcmp(str, "Marcel"));

	result = l_dbus_message_iter_next_entry(&array2, &str);
	assert(result);
	assert(!strcmp(str, "Holtmann"));

	result = l_dbus_message_iter_next_entry(&array2, &str);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_array_6(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter array, iter;
	const char *str;
	uint32_t val;
	bool result;

	result = l_dbus_message_get_arguments(msg, "av", &array);
	assert(result);

	result = l_dbus_message_iter_next_entry(&array, &iter);
	assert(result);

	result = l_dbus_message_iter_get_variant(&iter, "s", &str);
	assert(result);
	assert(!strcmp(str, "Linus Torvalds"));

	result = l_dbus_message_iter_next_entry(&array, &iter);
	assert(result);

	result = l_dbus_message_iter_get_variant(&iter, "b", &val);
	assert(result);
	assert(val == 1);

	result = l_dbus_message_iter_next_entry(&array, &iter);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_dict_1(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter dict, iter;
	const char *str;
	bool result;

	result = l_dbus_message_get_arguments(msg, "a{sv}", &dict);
	assert(result);

	result = l_dbus_message_iter_next_entry(&dict, &str, &iter);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_dict_2(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter dict, iter;
	const char *str;
	uint32_t val;
	bool result;

	result = l_dbus_message_get_arguments(msg, "a{sv}", &dict);
	assert(result);

	result = l_dbus_message_iter_next_entry(&dict, &str, &iter);
	assert(result);
	assert(!strcmp(str, "Name"));

	result = l_dbus_message_iter_get_variant(&iter, "s", &str);
	assert(result);
	assert(!strcmp(str, "Linus Torvalds"));

	result = l_dbus_message_iter_next_entry(&dict, &str, &iter);
	assert(result);
	assert(!strcmp(str, "Developer"));

	result = l_dbus_message_iter_get_variant(&iter, "b", &val);
	assert(result);
	assert(val == 1);

	result = l_dbus_message_iter_next_entry(&dict, &str, &iter);
	assert(!result);

	l_dbus_message_unref(msg);
}

static void check_dict_3(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter dict;
	const char *str1, *str2;
	bool result;

	result = l_dbus_message_get_arguments(msg, "a{ss}", &dict);
	assert(result);

	result = l_dbus_message_iter_next_entry(&dict, &str1, &str2);
	assert(result);
	assert(!strcmp(str1, "Linus"));
	assert(!strcmp(str2, "Torvalds"));

	result = l_dbus_message_iter_next_entry(&dict, &str1, &str2);
	assert(result);
	assert(!strcmp(str1, "Marcel"));
	assert(!strcmp(str2, "Holtmann"));

	result = l_dbus_message_iter_next_entry(&dict, &str1, &str2);
	assert(!result);

        l_dbus_message_unref(msg);
}

static void check_variant_1(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter iter;
	const char *str;
	bool result;

	result = l_dbus_message_get_arguments(msg, "v", &iter);
	assert(result);

	result = l_dbus_message_iter_get_variant(&iter, "s", &str);
	assert(result);
	assert(!strcmp(str, "Linus Torvalds"));

	l_dbus_message_unref(msg);
}

static void check_variant_2(const void *data)
{
	struct l_dbus_message *msg = check_message(data);
	struct l_dbus_message_iter iter, array;
	const char *str;
	bool result;

	result = l_dbus_message_get_arguments(msg, "v", &iter);
	assert(result);

	result = l_dbus_message_iter_get_variant(&iter, "as", &array);
	assert(result);

	result = l_dbus_message_iter_next_entry(&array, &str);
	assert(result);
	assert(!strcmp(str, "Linus"));

	result = l_dbus_message_iter_next_entry(&array, &str);
	assert(result);
	assert(!strcmp(str, "Torvalds"));

	result = l_dbus_message_iter_next_entry(&array, &str);
	assert(!result);

	l_dbus_message_unref(msg);
}

int main(int argc, char *argv[])
{
	l_test_init(&argc, &argv);

	l_test_add("Basic 1", check_basic_1, &message_data_basic_1);
	l_test_add("Basic 2", check_basic_2, &message_data_basic_2);
	l_test_add("Basic 3", check_basic_3, &message_data_basic_3);

	l_test_add("Struct 1", check_struct_1, &message_data_struct_1);
	l_test_add("Struct 2", check_struct_2, &message_data_struct_2);

	l_test_add("Array 1", check_array_1, &message_data_array_1);
	l_test_add("Array 2", check_array_2, &message_data_array_2);
	l_test_add("Array 3", check_array_3, &message_data_array_3);
	l_test_add("Array 4", check_array_4, &message_data_array_4);
	l_test_add("Array 5", check_array_5, &message_data_array_5);
	l_test_add("Array 6", check_array_6, &message_data_array_6);

	l_test_add("Dict 1", check_dict_1, &message_data_dict_1);
	l_test_add("Dict 2", check_dict_2, &message_data_dict_2);
	l_test_add("Dict 3", check_dict_3, &message_data_dict_3);

	l_test_add("Variant 1", check_variant_1, &message_data_variant_1);
	l_test_add("Variant 2", check_variant_2, &message_data_variant_2);

	return l_test_run();
}
